<report
    title="Reference output count"
    description="Provides a count of the records included in a reference range filter"
    >
  <query>
    select count(*) as filtercount
    from ecobat_occurrences o
    where 1=1
    #filters#
  </query>
  <params>
    <param name="filter_spatial_km" display="Limit area km" description="Number of km of radius to limit the reference set to." datatype="integer" default="">
      <where>|/ (
        (st_x(st_centroid(st_transform(st_geomfromtext('#input_geom#', 900913), 27700))) - o.easting) ^ 2
        + (st_y(st_centroid(st_transform(st_geomfromtext('#input_geom#', 900913), 27700))) - o.northing) ^ 2
        ) &lt; #filter_spatial_km#*1000</where>
    </param>
    <param name="filter_date_limit" display="Limit day in year" description="Limit to records +/- 30 days of the input" datatype="boolean" default="" >
      <where>
        case
        when extract(doy from '#input_date#'::date) &gt;= 30 and extract(doy from '#input_date#'::date) &lt;= 335 then
        day_of_year &lt;= extract(doy from '#input_date#'::date) + 30 and day_of_year &gt;= extract(doy from '#input_date#'::date) - 30
        when #input_date# &lt; 30 then
        day_of_year &lt;= extract(doy from '#input_date#'::date) + 30 or day_of_year &gt;= extract(doy from '#input_date#'::date) + 365 - 30
        else
        day_of_year &gt;= extract(doy from '#input_date#'::date) - 30 or day_of_year &lt;= extract(doy from '#input_date#'::date) - 365 + 30
        end
      </where>
    </param>
    <param name="input_date" display="Date" description="Date of the record to compare against" datatype="date" default="" />
    <param name="input_geom" display="Geometry" description="Geometry of site being passed into the report" datatype="text" />
  </params>
</report>