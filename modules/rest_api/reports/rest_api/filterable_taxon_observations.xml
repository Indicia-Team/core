<report
    title="Taxon observation format for RESTful API"
    description="Report to support taxon-observations resource output for the RESTful API. Compatible with the standard report filter parameters."
>
  <query website_filter_field="o.website_id" samples_id_field="o.sample_id" standard_params="true">
select #columns#
from occurrences occ -- for access to external_key
left join cache_occurrences o on o.id=occ.id
join websites w on w.id=o.website_id
left join groups g on g.id=o.group_id
left join sample_attribute_values dn on dn.sample_id=o.sample_id and dn.deleted=false and dn.sample_attribute_id=#dataset_name_attr_id#
#agreements_join#
#joins#
where #sharing_filter# 
and o.date_type in ('D','DD','O','OO','Y','YY','-Y','U') 
and (o.entered_sref_system ilike 'osgb' or o.entered_sref_system ilike 'osie' or o.entered_sref_system = '4326' or o.entered_sref_system = '27700')
and o.taxa_taxon_list_external_key is not null
#idlist#
  </query>
  
  <order_bys>
    <order_by>o.id ASC</order_by>
  </order_bys>
  <params>
    <param name='system_user_id' display='System ID' description='3 character code identifying the system' datatype='text' />
    <param name='smpattrs' display='Sample attribute list' description='Comma separated list of sample attribute IDs to include' datatype='smpattrs' default="" />
    <param name='occattrs' display='Occurrence attribute list' description='Comma separated list of occurrence attribute IDs to include' datatype='occattrs' default="" />
    <param name='external_key' display="External system key" description="UID of this key from the source system" datatype="text" default="">
      <where>occ.external_key='#external_key#'</where>
    </param>
    <param name="dataset_name_attr_id" display = "Dataset Name Attr ID" description="Sample attribute ID to store dataset name for remotely sourced records"
           datatype="integer" />"
  </params>
  <columns>
    <column name='id' display='ID' sql="COALESCE(occ.external_key, '#system_user_id#' || o.id::varchar)" datatype="text" />
    <column name='DatasetName' display='Dataset Name' datatype="text"
            sql="coalesce(dn.text_value, w.title || '::' || o.survey_title || coalesce('::' || g.title, ''))" />
    <column name='TaxonVersionKey' display='Taxon Version Key' sql='o.taxa_taxon_list_external_key' datatype="text" />
    <column name='TaxonName' display='Taxon Name' sql='o.taxon' datatype="text" />
    <column name='ZeroAbundance' display='Zero Abundance' sql='upper(cast (o.zero_abundance as character))' datatype="text" />
    <column name='Sensitive' display='Sensitive' sql="case when o.sensitivity_precision is null then 'F' else 'T' end" datatype="text" />
    <column name='StartDate' display='Start Date' sql='cast(o.date_start as character varying)' datatype="text" />
    <column name='EndDate' display='End Date' sql='cast(o.date_end as character varying)' datatype="text" />
    <column name='DateType' display='Date Type' sql='o.date_type' datatype="integer" />
    <column name='SiteKey' display='SiteKey' sql="'#system_user_id#' || o.location_id::varchar" datatype="text" />
    <column name='SiteName' display='SiteName' sql='substring(o.location_name, 1, 100)' datatype="text" />
    <column name='GridReference' display='GridReference' sql="case when o.entered_sref_system in ('4326', '27700') then null else replace(coalesce(o.public_entered_sref, o.output_sref), ' ', '') end" datatype="text" />
    <column name='East' display='East' sql="case when o.entered_sref_system in ('4326', '27700') then st_x(st_transform(st_centroid(public_geom), o.entered_sref_system::int)) else null end" datatype="text" />
    <column name='North' display='North' sql="case when o.entered_sref_system in ('4326', '27700') then st_y(st_transform(st_centroid(public_geom), o.entered_sref_system::int)) else null end" datatype="text" />
    <column name='Projection' display='Projection' 
        sql="case upper(o.entered_sref_system) when '4326' then 'WGS84' when '27700' then 'OSGB36' when 'OSIE' then 'OSI' else upper(o.entered_sref_system) end" 
        datatype="text" />
    <column name='Precision' display='Precision' 
        sql="case o.entered_sref_system
    when '4326' then 50 
    when '27700' then 1
    else case length(replace(o.public_entered_sref, ' ', '')) when 5 then 2000 else pow(10, (12-length(replace(coalesce(o.public_entered_sref, o.output_sref), ' ', '')))/2) end
  end" 
        datatype="text" />
    <column name='Recorder' display='Recorder' sql='o.recorders' datatype="text" />
    <column name='Delete' display='Delete' sql="case occ.deleted when 't' then 'T' end" />
    <column name='lasteditdate' display='Last Edit Date' sql="substring(replace(occ.updated_on::varchar, ' ', 'T') from 1 for 19)" />
    <!-- @todo determiner -->
  </columns>
</report>