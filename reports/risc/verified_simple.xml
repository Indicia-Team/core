<?xml version="1.0" encoding="UTF-8"?>

<report title="All occurrences" description="Lists all occurrences for a survey.">
  <comment>
    This report depends upon this function having been created in the database.
    CREATE AGGREGATE CONCAT (
        BASETYPE = text,
        SFUNC = textcat,
        STYPE = text,
        INITCOND = ''
    );
  </comment>
  <query>
    SELECT  s.id AS sam_id,
            o.id AS occ_id,
            s.date_start AS date,
            sav1.text_value || ' ' || sav2.text_value AS name,
            s.location_name AS location,
            o.comment AS occ_comment,
            (SELECT CONCAT('&lt;a class="fancybox" href="http://warehouse1.indicia.org.uk/upload/' ||
                            path ||
                            '"&gt;'
                            '&lt;img src="http://warehouse1.indicia.org.uk/upload/thumb-' ||
                            path ||
                            '" /&gt;' ||
                            '&lt;/a&gt;')
             FROM occurrence_images
             WHERE occurrence_id = o.id
            ) AS photos
    FROM samples as s
    JOIN occurrences o on o.sample_id = s.id
    JOIN sample_attribute_values sav1 ON sav1.sample_id = s.id AND sav1.sample_attribute_id = 6
    JOIN sample_attribute_values sav2 ON sav2.sample_id = s.id AND sav2.sample_attribute_id = 7
    WHERE s.survey_id = #survey# AND 
          s.deleted = FALSE AND 
          o.taxa_taxon_list_id = #taxon# AND
          o.record_status = 'V'
  </query>

  <params>
    <param name="survey" />
    <param name="taxon" />
  </params>

  <order_bys>
    <order_by>s.id DESC</order_by>
  </order_bys>

  <columns>
    <column name="sam_id" display="Sample" />
    <column name="occ_id" visible="false" />
    <column name="date" display="Date" />
    <column name="name" display="Name" />
    <column name="location" display="Location" />
    <column name="occ_comment" display="Comment" />
    <column name="photos" display="Photos" />
  </columns>

  </report>