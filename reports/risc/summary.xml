<?xml version="1.0" encoding="UTF-8"?>

<report title="RISC Summary" description="Lists number of records, verified records and records awaiting verification by species">
  <query>
      SELECT t.taxon,
        COUNT(NULLIF(zero_abundance, false)) AS num_absence,
        COUNT(NULLIF(zero_abundance, true)) AS num_presence,
        (COUNT(o.id) - COUNT(NULLIF(record_status, 'V'))) AS num_verified,
        COUNT(has_photo || NULLIF(record_status, 'V') || NULLIF(record_status, 'R')) AS num_waiting
      FROM indicia.occurrences o
      JOIN indicia.taxa_taxon_lists ttl ON ttl.id = o.taxa_taxon_list_id
      JOIN indicia.taxa t ON t.id = ttl.taxon_id
      LEFT JOIN (SELECT DISTINCT occurrence_id, '1' AS has_photo FROM indicia.occurrence_images) oi ON oi.occurrence_id = o.id
      WHERE website_id = 3
      AND o.deleted = 'false'
      GROUP BY t.taxon
  </query>

  <order_bys>
    <order_by>num_presence DESC</order_by>
  </order_bys>

  <columns>
    <column name="taxon" display="Taxon" />
    <column name="num_absence" display="Absence records" />
    <column name="num_presence" display="Submitted records" />
    <column name="num_verified" display="Verified records" />
    <column name="num_waiting" display="Awaiting verification" />
  </columns>

  </report>