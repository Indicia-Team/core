<?xml version="1.0" encoding="UTF-8"?>

<report title="All mitten crab occurrences" description="Lists all occurrences for mitten crab including every field.">
  <comment>
    This report depends upon this function having been created in the database.
    CREATE AGGREGATE CONCAT (
        BASETYPE = text,
        SFUNC = textcat,
        STYPE = text,
        INITCOND = ''
    );
  </comment>
  <query>
    SELECT  s.id AS sam_id,
             (CASE 
               WHEN o.record_status = 'C' THEN 'New'
               WHEN o.record_status = 'V' THEN 'Verified'
               WHEN o.record_status = 'R' THEN 'Rejected'
               WHEN o.record_status = 'S' THEN 'Sent'
              END
            )AS status,
           (SELECT term FROM terms t
               LEFT JOIN occurrence_attribute_values oav on oav.int_value = t.id 
               WHERE oav.occurrence_id = o.id AND oav.occurrence_attribute_id = 53) AS certainty,
            o.id AS occ_id,
            s.date_start AS date,
            (SELECT term FROM terms t
               LEFT JOIN sample_attribute_values sav on sav.int_value = t.id 
               WHERE sav.sample_id = s.id AND sav.sample_attribute_id = 5) || ' ' || 
            sav1.text_value || ' ' || sav2.text_value AS name,
            sav3.text_value AS email,
            (SELECT term FROM terms t
               LEFT JOIN sample_attribute_values sav on sav.int_value = t.id 
               WHERE sav.sample_id = s.id AND sav.sample_attribute_id = 27) AS county,
            s.location_name AS location,
            s.entered_sref,
            (SELECT text_value FROM sample_attribute_values sav
              WHERE sav.sample_id = s.id AND sav.sample_attribute_id = 30) AS habitat,
            (SELECT int_value FROM occurrence_attribute_values oav
              WHERE oav.occurrence_id = o.id AND oav.occurrence_attribute_id = 3) AS abundance,
            (SELECT term FROM terms t
               LEFT JOIN occurrence_attribute_values oav on oav.int_value = t.id 
               WHERE oav.occurrence_id = o.id AND oav.occurrence_attribute_id = 5) AS alive,
             o.comment as occ_comment,
            (SELECT CONCAT('&lt;a class="fancybox" href="http://warehouse1.indicia.org.uk/upload/' ||
                            path ||
                            '"&gt;'
                            '&lt;img src="http://warehouse1.indicia.org.uk/upload/thumb-' ||
                            path ||
                            '" /&gt;' ||
                            '&lt;/a&gt;')
             FROM occurrence_images
             WHERE occurrence_id = o.id
            ) AS photos,
            (SELECT 
              (CASE 
                WHEN int_value = 1 THEN 'Yes'
                WHEN int_value = 0 THEN 'No'
                END)
              FROM sample_attribute_values sav
              WHERE sav.sample_id = s.id AND sav.sample_attribute_id = 31) AS reply            
    FROM samples as s
    JOIN occurrences o on o.sample_id = s.id
    JOIN sample_attribute_values sav1 ON sav1.sample_id = s.id AND sav1.sample_attribute_id = 6
    JOIN sample_attribute_values sav2 ON sav2.sample_id = s.id AND sav2.sample_attribute_id = 7
    JOIN sample_attribute_values sav3 ON sav3.sample_id = s.id AND sav3.sample_attribute_id = 8
    WHERE s.survey_id = 5 AND 
          s.deleted = FALSE AND 
          o.zero_abundance = FALSE AND
          o.taxa_taxon_list_id = 11
  </query>

  <order_bys>
    <order_by>s.id DESC</order_by>
  </order_bys>

  <columns>
    <column name="sam_id" display="Sample" />
    <column name="status" display="Status" />
    <column name="certainty" display="Certainty" />
    <column name="occ_id" visible="false" />
    <column name="date" display="Date" />
    <column name="name" display="Name" />
    <column name="email" display="Email" />
    <column name="county" display="County" />
    <column name="location" display="Location" />
    <column name="entered_sref" display="Grid ref" />
    <column name="habitat" display="Habitat" />
    <column name="abundance" display="Count" />
    <column name="alive" display="Alive" />
    <column name="occ_comment" display="Comment" />
    <column name="photos" display="Photos" />
    <column name="reply" display="Reply" />
  </columns>

  </report>