<?xml version="1.0" encoding="UTF-8"?>

<report
  title="RISC Verification"
  description="Lists all unverified occurrences for given survey, taxon and email."
>
  <comment>
    This report depends upon this function having been created in the database.
    CREATE AGGREGATE CONCAT (
        BASETYPE = text,
        SFUNC = textcat,
        STYPE = text,
        INITCOND = ''
    );
  </comment>
  <query>
    SELECT  s.id AS sample_id,
            s.date_start AS date,
            sav1.text_value || ' ' || sav2.text_value AS name,
            sav3.text_value AS email,
            'Grid ref: ' ||s.entered_sref || '. ' || s.location_name AS location,
            o.comment AS occ_comment,
            (SELECT CONCAT('&lt;a class="fancybox" href="http://testwarehouse.indicia.org.uk/upload/' ||
                                        oi.path ||
                                        '"&gt;' ||
                                        '&lt;img src="http://testwarehouse.indicia.org.uk/upload/thumb-' ||
                                        oi.path ||
                                        '" /&gt;' ||
                                        '&lt;/a&gt;')
              FROM occurrence_images oi WHERE occurrence_id = o.id) AS photos,
              o.id as occurrence_id,
              (
                SELECT t.taxon
                FROM indicia.taxa t
                JOIN indicia.taxa_taxon_lists ttl ON t.id = ttl.taxon_id
                WHERE ttl.id = #taxon#) AS taxon
    FROM samples as s
    JOIN occurrences o on o.sample_id = s.id
    JOIN indicia.sample_attribute_values sav1 on sav1.sample_id = s.id AND sav1.sample_attribute_id = 6
    JOIN indicia.sample_attribute_values sav2 on sav2.sample_id = s.id AND sav2.sample_attribute_id = 7
    JOIN indicia.sample_attribute_values sav3 on sav3.sample_id = s.id AND sav3.sample_attribute_id = 8
    WHERE s.survey_id = #survey# AND
          s.deleted = FALSE AND
          o.record_status = 'C' AND
          o.taxa_taxon_list_id = #taxon# AND
          sav3.text_value = '#email#'
  </query>

  <params>
    <param name="survey" />
    <param name="taxon" />
    <param name='email' display='Name' description='Select the person to return data for.' datatype='lookup'
        lookup_values='djf2qn@aol.com:David Fuller' emptyvalue='0' />
  </params>

  <order_bys>
    <order_by>s.id ASC</order_by>
  </order_bys>

  <columns>
    <column name="sample_id" display="Sample" />
    <column name="date" display="Date" />
    <column name="name" display="Name" />
    <column name="email" display="Email" />
    <column name="location" display="Location" />
    <column name="occ_comment" display="Comment" />
    <column name="photos" display="Photos" />
    <column name="occurrence_id" visible="false" />
    <column name="taxon" visible="false" />
  </columns>

  </report>