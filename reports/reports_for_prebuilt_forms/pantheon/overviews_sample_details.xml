<report
    title="Overviews - sample details"
    description="A report to display the sample information on various sample details pages."
>
<query website_filter_field="su.website_id">
  SELECT #columns#
  FROM samples s
    JOIN surveys su on su.id=s.survey_id and su.deleted=false
    LEFT JOIN locations l on l.id = s.location_id AND l.deleted=false
    LEFT JOIN occurrences o on o.sample_id = s.id AND o.deleted = false
    LEFT JOIN occurrence_attribute_values oavQuant on oavQuant.occurrence_id = o.id AND oavQuant.occurrence_attribute_id = #quantity_occ_attr_id# AND oavQuant.deleted = false
    LEFT JOIN taxa_taxon_lists ttl on ttl.id = o.taxa_taxon_list_id AND ttl.deleted = false
  WHERE s.id = #sample_id#
  AND #website_filter#
  </query>
  <params>
    <param name='sample_id' display='Sample' description='Sample id to retrieve data for.' datatype='integer'/>
    <param name='quantity_occ_attr_id' display='Quantity Occurrence Attribute Id' description='Occurrance attribute that holds the abundance for an occurrence.' datatype='integer'/>
    <param name='taxa_taxon_list_trait_attr_ids' display='Trait Attribute Ids' description='Comma separated in of the attribute ids that hold species traits.' datatype='text'/>
  </params>
  <columns>
    <column name='sample_id' sql='s.id' display='Sample ID' in_count='true'/>
    <column name='site_name' sql='coalesce(l.name,s.location_name)' display='Site Name' />
    <column name='date_of_survey' sql='s.date_start' display='Date of Survey' />
    <column name='surveyor' sql='s.recorder_names' display='Surveyor' />
    <column name='grid_ref' sql='s.entered_sref' display='Grid Ref' />
    <!-- There is a Reference field in the screenshot, what should that contain -->
    <column name='comments' sql='s.comment' display='Comments' />
    <column name='sample_size' sql='sum(oavQuant.int_value)' display='Sample Size' aggregate='true'/>
    -- Number Analysed is the summed abundance in the sample that actually have traits, as the user
    can select any species, not just pantheon ones with traits
    <column name='number_analysed' sql='
    sum(case when 
    (select count(*)
    from taxa_taxon_list_attribute_values ttlAV 
    where ttlAV.taxa_taxon_list_id=o.taxa_taxon_list_id AND ttlAV.taxa_taxon_list_attribute_id in (#taxa_taxon_list_trait_attr_ids#) AND ttlAV.deleted = false)
    > 0 then oavQuant.int_value else 0 END)
    ' display='Number Analysed' aggregate='true'/>
    --What percentage of the sample's summed abundance actually have Pantheon traits.
    <column name='percent_return' sql='
    round(
      (sum(case when 
        (select count(*)
        from taxa_taxon_list_attribute_values ttlAV 
        where ttlAV.taxa_taxon_list_id=o.taxa_taxon_list_id AND ttlAV.taxa_taxon_list_attribute_id in (#taxa_taxon_list_trait_attr_ids#) AND ttlAV.deleted = false)
      > 0 then oavQuant.int_value else 0 END)) 
      / 
      cast(sum(oavQuant.int_value) as numeric) 
      * 100
    ,0)
' display='% Return' aggregate='true'/>
  </columns>
</report>