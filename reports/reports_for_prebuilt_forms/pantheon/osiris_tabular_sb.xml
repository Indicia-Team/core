<report title="Osiris tabular specific biotopes"
        description="Tabular output for Osiris specific biotopes for a sample.">
  <query website_filter_field="o.website_id">
    select #columns#
    from cache_samples_functional s
    join cache_occurrences_functional o on o.website_id=s.website_id and o.survey_id=s.survey_id and o.sample_id=s.id
    join cache_taxa_taxon_lists ttl on ttl.id=o.preferred_taxa_taxon_list_id
    join taxa_taxon_list_attribute_values av_sb on av_sb.taxa_taxon_list_id=ttl.id and av_sb.deleted=false
      and av_sb.taxa_taxon_list_attribute_id=#sb_attr_id#
    join cache_termlists_terms t_sb on t_sb.id=av_sb.int_value
    left join cache_termlists_terms t_bb on t_bb.id=t_sb.parent_id
    where s.id=#sample_id#
  </query>
  <order_bys>
    <order_by>count desc</order_by>
  </order_bys>
  <params>
    <param name="sample_id" display="Sample ID"  datatype="integer"/>
    <param name="sb_attr_id" display="Specific biotope attribute ID" datatype="integer"/>
  </params>
  <columns>
    <column name="bb_term" sql="t_bb.term" display="Broad biotope" />
    <column name="id" sql="t_sb.id" visible="false" in_count="true" />
    <column name="term" sql="t_sb.term" display="Specific biotope" />
    <column name="count" sql="count(o.preferred_taxa_taxon_list_id)" display="Count" aggregate="true"/>
    <column name="ret" display="% return" aggregate="true"
            sql="count(o.preferred_taxa_taxon_list_id) * 100 / (
      select count(osub.id) from cache_samples_functional ssub
      join cache_occurrences_functional osub
        on osub.website_id=ssub.website_id and osub.survey_id=ssub.survey_id and osub.sample_id=ssub.id
      where ssub.id=#sample_id#
    )" />
  </columns>
</report>