<report
    title="Full species index"
    description="A report which lists all Pantheon species along with trait data."
    >
  <query website_filter_field="o.website_id">
select #columns#
from cache_taxa_taxon_lists cttl
join taxa_taxon_lists ttl on ttl.id=cttl.preferred_taxa_taxon_list_id
left join (taxa_taxon_designations ttd
join taxon_designations td on td.id=ttd.taxon_designation_id and td.deleted=false and td.title like 'IUCN%'
) on ttd.taxon_id=ttl.taxon_id
left join taxa_taxon_list_attribute_values av_bb on av_bb.taxa_taxon_list_id=ttl.id and av_bb.deleted=false
and av_bb.taxa_taxon_list_attribute_id=#bb_attr_id#
left join cache_termlists_terms t_bb on t_bb.id=av_bb.int_value
left join cache_termlists_terms isisbatcode on isisbatcode.meaning_id=t_bb.meaning_id and isisbatcode.preferred=false
left join taxa_taxon_list_attribute_values av_sb on av_sb.taxa_taxon_list_id=ttl.id and av_sb.deleted=false
and av_sb.taxa_taxon_list_attribute_id=#sb_attr_id#
left join cache_termlists_terms t_sb on t_sb.id=av_sb.int_value
left join cache_termlists_terms isissatcode on isissatcode.meaning_id=t_sb.meaning_id and isissatcode.preferred=false
left join taxa_taxon_list_attribute_values av_r on av_r.taxa_taxon_list_id=ttl.id and av_r.deleted=false
and av_r.taxa_taxon_list_attribute_id=#r_attr_id#
left join cache_termlists_terms t_r on t_r.id=av_r.int_value
left join cache_termlists_terms t_r_parent on t_r_parent.id=t_r.parent_id
left join cache_termlists_terms t_r_grandparent on t_r_grandparent.id=t_r_parent.parent_id
left join taxa_taxon_list_attribute_values lguildv on lguildv.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and lguildv.deleted=false
  and lguildv.taxa_taxon_list_attribute_id=9 -- parameter for larval guild attribute ID
left join cache_termlists_terms lguildterm on lguildterm.id=lguildv.int_value  
left join taxa_taxon_list_attribute_values aguildv on aguildv.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and aguildv.deleted=false
  and aguildv.taxa_taxon_list_attribute_id=8 -- parameter for adult guild attribute ID
left join cache_termlists_terms aguildterm on aguildterm.id=aguildv.int_value
left join taxa_taxon_list_attribute_values av_rarity on av_rarity.taxa_taxon_list_id=ttl.id and av_rarity.deleted=false
    and av_rarity.taxa_taxon_list_attribute_id=#rarity_attr_id#
left join (taxa_taxon_list_attribute_values horusv
  join taxa_taxon_list_attributes horusa on horusa.id=horusv.taxa_taxon_list_attribute_id and horusa.deleted=false 
  and horusa.caption like '%score%' and horusa.caption&lt;&gt;'rarity score'
) on horusv.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and horusv.deleted=false
where (av_bb.id is not null or av_sb.id is not null or av_r.id is not null
    or lguildv.id is not null or aguildv.id is not null or horusv is not null)
    and cttl.preferred=true
#filters#
  </query>
  <order_bys>
    <order_by>cttl.order_taxon</order_by>
  </order_bys>
  <params>
    <param name='bb_attr_id' display='Broad biotope attribute ID' datatype='integer'/>
    <param name='sb_attr_id' display='Specific biotope attribute ID' datatype='integer'/>
    <param name='r_attr_id' display='Resource attribute ID' datatype='integer'/>
    <param name='rarity_attr_id' display='Rarity score attribute ID' datatype='integer'/>
    <param name='taxon_group_id' display='Taxon group' description='ID of taxon group to filter to' datatype='integer' default=''>
      <where>cttl.taxon_group_id=#taxon_group_id#</where>
    </param>
  </params>
  <columns>
    <column name="species" sql="cttl.preferred_taxon" display="Species" in_count="true" />
    <column name="order" sql="cttl.order_taxon" display="Order" in_count="true" />
    <column name="designations" sql="array_to_string(array_agg(distinct coalesce(td.id::varchar, td.code, td.abbreviation)), ';')" display="Conservation status" aggregate="true" />
    <column name="isis_bat_code" sql="isisbatcode.term" display="ISIS BAT code" />
    <column name="isis_sat_code" sql="isissatcode.term" display="ISIS SAT code" />
    <column name="broad_biotope" display="Broad habitat" sql="array_to_string(array_agg(distinct t_bb.term), '; ')" aggregate="true" />
    <column name="specific_biotope" display="Specific biotope" sql="array_to_string(array_agg(distinct t_sb.term), '; ')" aggregate="true" />
    <column name="resource" display="Resource" aggregate="true"
            sql="'[' || array_to_string(array_agg(distinct '[' || t_r.id || ',' || case when t_r_grandparent.id is not null and t_r_grandparent.parent_id is null then 0 else t_r.parent_id end || ',&quot;' || t_r.term || '&quot;]'), ',') || ']'" />
    <column name="larval_guild" sql="string_agg(distinct lguildterm.term,';')" display="Larval guild" aggregate="true" />
    <column name="adult_guild" sql="string_agg(distinct aguildterm.term,';')" display="Adult guild" aggregate="true" />
    <column name="rarity_score" sql="av_rarity.int_value" display="Rarity score" />
    <column name="horus_indicator" sql="array_to_string(array_agg(distinct coalesce(horusa.caption || ': ' || horusv.int_value::varchar)), ', ')" display="HORUS indicator" aggregate="true" />
  </columns>
</report>