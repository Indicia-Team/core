<report
    title="OSIRIS species tabular"
    description="Lists all species in a sample with OSIRIS traits summarised."
    >
  <query website_filter_field="cttl.website_id">
    select #columns#
    from cache_taxa_taxon_lists cttl
    left join taxa_taxon_list_attribute_values av_bb on av_bb.taxa_taxon_list_id=cttl.id and av_bb.deleted=false
        and av_bb.taxa_taxon_list_attribute_id=#bb_attr_id#
    left join cache_termlists_terms t_bb on t_bb.id=av_bb.int_value
    left join taxa_taxon_list_attribute_values av_sb on av_sb.taxa_taxon_list_id=cttl.id and av_sb.deleted=false
        and av_sb.taxa_taxon_list_attribute_id=#sb_attr_id#
    left join cache_termlists_terms t_sb on t_sb.id=av_sb.int_value
    left join taxa_taxon_list_attribute_values av_r on av_r.taxa_taxon_list_id=cttl.id and av_r.deleted=false
        and av_r.taxa_taxon_list_attribute_id=#r_attr_id#
    left join cache_termlists_terms t_r on t_r.id=av_r.int_value
    #joins#
  </query>
  <order_bys>
    <order_by>cttl.kingdom_taxon, cttl.order_taxon || '; ' || cttl.family_taxon, cttl.taxon</order_by>
  </order_bys>
  <params>
    <param name="sample_id" display="Sample or scratchpad ID"  datatype="integer"/>
    <param name="sample_type" display="Sample type" datatype="lookup" default="sample"
           lookupValues="sample:Sample,scratchpad:Scratchpad list">
      <joins>
        <join operator="equal" value="sample">
          join cache_occurrences_functional o on o.preferred_taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id
          join cache_samples_functional s on s.website_id=o.website_id and s.survey_id=o.survey_id and s.id=o.sample_id
          and s.id=#sample_id#
        </join>
        <join operator="equal" value="scratchpad">
          join scratchpad_list_entries sle on sle.entry_id=cttl.preferred_taxa_taxon_list_id
          join scratchpad_lists s on s.id=sli.scratchpad_list_id and s.deleted=false
          and s.scratchpad_list_id=#sample_id#
        </join>
      </joins>
    </param>
    <param name='bb_attr_id' display='Broad biotope attribute ID' datatype='integer'/>
    <param name='sb_attr_id' display='Specific biotope attribute ID' datatype='integer'/>
    <param name='r_attr_id' display='Resource attribute ID' datatype='integer'/>
  </params>
  <columns>
    <column name="taxa_taxon_list_id" sql="cttl.id" display="ID" visible="false" in_count="true" />
    <column name="species" sql="cttl.taxon" display="Species" />
    <column name="kingdom" sql="cttl.kingdom_taxon" visible="false" />
    <column name="taxonomic" sql="cttl.order_taxon || '; ' || cttl.family_taxon" display="Taxonomic" />
    <column name="broad_biotope" display="Broad habitat" sql="array_to_string(array_agg(distinct t_bb.term), '; ')" aggregate="true" />
    <column name="specific_biotope" display="Specific biotope" sql="array_to_string(array_agg(distinct t_sb.term), '; ')" aggregate="true" />
    <column name="resource" display="Resource" sql="array_to_string(array_agg(distinct t_r.term), '; ')" aggregate="true" />
  </columns>
</report>