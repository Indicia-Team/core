<report
    title="OSIRIS species tabular"
    description="Lists all species in a sample with OSIRIS traits summarised."
    >
  <query website_filter_field="o.website_id">
    select #columns#
    from cache_occurrences o
    join cache_taxa_taxon_lists ttl on ttl.id=o.preferred_taxa_taxon_list_id
    left join taxa_taxon_list_attribute_values av_bb on av_bb.taxa_taxon_list_id=ttl.id and av_bb.deleted=false
        and av_bb.taxa_taxon_list_attribute_id=#bb_attr_id#
    left join cache_termlists_terms t_bb on t_bb.id=av_bb.int_value
    left join taxa_taxon_list_attribute_values av_sb on av_sb.taxa_taxon_list_id=ttl.id and av_sb.deleted=false
        and av_sb.taxa_taxon_list_attribute_id=#sb_attr_id#
    left join cache_termlists_terms t_sb on t_sb.id=av_sb.int_value
    left join taxa_taxon_list_attribute_values av_r on av_r.taxa_taxon_list_id=ttl.id and av_r.deleted=false
        and av_r.taxa_taxon_list_attribute_id=#r_attr_id#
    left join cache_termlists_terms t_r on t_r.id=av_r.int_value
    where o.sample_id=#sample_id#
    #filters#
  </query>
  <order_bys>
    <order_by>ttl.kingdom_taxon, ttl.order_taxon || '; ' || ttl.family_taxon, ttl.taxon</order_by>
  </order_bys>
  <params>
    <param name='sample_id' display='Sample ID'  datatype='integer'/>
    <param name='bb_attr_id' display='Broad biotope attribute ID' datatype='integer'/>
    <param name='sb_attr_id' display='Specific biotope attribute ID' datatype='integer'/>
    <param name='r_attr_id' display='Resource attribute ID' datatype='integer'/>
  </params>
  <columns>
    <column name="taxa_taxon_list_id" sql="ttl.id" display="ID" visible="false" in_count="true" />
    <column name="species" sql="ttl.taxon" display="Species" />
    <column name="kingdom" sql="ttl.kingdom_taxon" visible="false" />
    <column name="taxonomic" sql="ttl.order_taxon || '; ' || ttl.family_taxon" display="Taxonomic" />
    <column name="broad_biotope" display="Broad habitat" sql="array_to_string(array_agg(distinct t_bb.term), '; ')" aggregate="true" />
    <column name="specific_biotope" display="Specific biotope" sql="array_to_string(array_agg(distinct t_sb.term), '; ')" aggregate="true" />
    <column name="resource" display="Resource" sql="array_to_string(array_agg(distinct t_r.term), '; ')" aggregate="true" />
  </columns>
</report>