<report
    title="Trait Species List"
    description="A report which lists all the species associated with an OSIRIS trait."
    >
  <query website_filter_field="o.website_id">
select #columns#
from taxa_taxon_list_attribute_values ttlav
join cache_occurrences o on o.preferred_taxa_taxon_list_id=ttlav.taxa_taxon_list_id
join cache_taxa_taxon_lists cttl on cttl.id=o.taxa_taxon_list_id 
join taxa_taxon_lists ttl on ttl.id=cttl.preferred_taxa_taxon_list_id
left join (taxa_taxon_designations ttd
join taxon_designations td on td.id=ttd.taxon_designation_id and td.deleted=false
) on ttd.taxon_id=ttl.taxon_id
left join (taxa_taxon_list_attribute_values isisv
  join cache_termlists_terms isisterm on isisterm.id=isisv.int_value
  join cache_termlists_terms isiscode on isiscode.meaning_id=isisterm.meaning_id and isiscode.preferred=false
  join taxa_taxon_list_attributes isisa on isisa.id=isisv.taxa_taxon_list_attribute_id and isisa.deleted=false and isisa.caption='ecological division'
) on isisv.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and isisv.deleted=false
left join taxa_taxon_list_attribute_values osirisv on osirisv.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and osirisv.deleted=false
  and osirisv.taxa_taxon_list_attribute_id in (158,159,160) -- parameter for OSIRIS trait IDs
left join cache_termlists_terms osiristerm on osiristerm.id=osirisv.int_value 
  and osiristerm.term not in ('trees known to be used', 'conifer or broadleaf', 'tree species', 'terrestrial aspect', 'woodland habitat', 'base status')
left join taxa_taxon_list_attribute_values lguildv on lguildv.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and lguildv.deleted=false
  and lguildv.taxa_taxon_list_attribute_id=9 -- parameter for larval guild attribute ID
left join cache_termlists_terms lguildterm on lguildterm.id=lguildv.int_value  
left join taxa_taxon_list_attribute_values aguildv on aguildv.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and aguildv.deleted=false
  and aguildv.taxa_taxon_list_attribute_id=8 -- parameter for adult guild attribute ID
left join cache_termlists_terms aguildterm on aguildterm.id=aguildv.int_value  
left join (taxa_taxon_list_attribute_values horusv
  join taxa_taxon_list_attributes horusa on horusa.id=horusv.taxa_taxon_list_attribute_id and horusa.deleted=false 
  and horusa.caption like '%score%' and horusa.caption&lt;&gt;'rarity score'
) on horusv.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and horusv.deleted=false
where ttlav.deleted=false
and ttlav.taxa_taxon_list_attribute_id=#trait_attr_id#
and ttlav.int_value=#trait_term_id#
and o.sample_id=#sample_id#
#filters#
  </query>
  <order_bys>
    <order_by>cttl.order_taxon</order_by>
  </order_bys>
  <params>
    <param name='sample_id' display='Sample' description='Sample id to retrieve data for.' datatype='integer'/>
    <param name='trait_attr_id' display='Ecological Division/Habitat or Resource Attribute Id' description='Trait attribute id for Ecological Division, Habitat or Resource.' datatype='integer'/>
    <param name="trait_term_id" display="Parent trait term ID" datatype="integer" />
  </params>
  <columns>
    <column name="species" sql="o.preferred_taxon" display="Species" in_count="true" />
    <column name="order" sql="cttl.order_taxon" display="Order" in_count="true" />
    <column name="designations" sql="array_to_string(array_agg(distinct coalesce(td.id::varchar, td.code, td.abbreviation)), ';')" display="Conservation status" aggregate="true" />
    <column name="isis_code" sql="isiscode.term" display="ISIS code" in_count="true" />
    <column name="osiris_traits" sql="array_to_string(array_agg(distinct osiristerm.term order by osiristerm.term), ';')" display="OSIRIS traits" aggregate="true" />
    <column name="larval_guild" sql="string_agg(distinct lguildterm.term,';')" display="Larval guild" aggregate="true" />
    <column name="adult_guild" sql="string_agg(distinct aguildterm.term,';')" display="Adult guild" aggregate="true" />
    <column name="horus_indicator" sql="array_to_string(array_agg(distinct coalesce(horusa.caption || ': ' || horusv.int_value::varchar)), ', ')" display="HORUS indicator" aggregate="true" />
  </columns>
</report>