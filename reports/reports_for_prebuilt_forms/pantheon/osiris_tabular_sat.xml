<report title="Osiris tabular" description="Tabular output for Osiris.">
  <query website_filter_field="o.website_id">
    select #columns#
    from cache_samples_functional s
    join cache_occurrences_functional o on o.website_id=s.website_id and o.survey_id=s.survey_id and o.sample_id=s.id
    join taxa_taxon_lists ttl on ttl.id=o.preferred_taxa_taxon_list_id
    join taxa_taxon_list_attribute_values av_bb on av_bb.taxa_taxon_list_id=ttl.id and av_bb.deleted=false
    and av_bb.taxa_taxon_list_attribute_id=#bb_attr_id#
    join cache_termlists_terms t_bb on t_bb.id=av_bb.int_value
    join taxa_taxon_list_attribute_values av_sb on av_sb.taxa_taxon_list_id=ttl.id and av_sb.deleted=false
    and av_sb.taxa_taxon_list_attribute_id=#sb_attr_id#
    join cache_termlists_terms t_sb on t_sb.id=av_sb.int_value and t_sb.parent_id=t_bb.id
    join taxa_taxon_list_attribute_values av_sat on av_sat.taxa_taxon_list_id=ttl.id and av_sat.deleted=false
    and av_sat.taxa_taxon_list_attribute_id=#sat_attr_id#
    join cache_termlists_terms t_sat on t_sat.id=av_sat.int_value
    left join cache_termlists_terms tcode on tcode.meaning_id=t_sat.meaning_id and tcode.preferred=false
    left join pantheon.isis_thresholds it on it.code=tcode.term
    join cache_termlists_terms p on p.id=t_sat.parent_id and (p.parent_id=t_sb.id or t_sat.parent_id=t_sb.id)
    left join taxa_taxon_designations ttd on ttd.taxon_id=ttl.taxon_id and ttd.deleted=false
    left join taxon_designations td on td.id=ttd.taxon_designation_id and td.deleted=false
    where s.id=#sample_id#
  </query>
  <order_bys>
    <order_by>count desc</order_by>
  </order_bys>
  <params>
    <param name='sample_id' display='Sample ID'  datatype='integer'/>
    <param name='bb_attr_id' display='Broad biotope attribute ID' datatype='integer'/>
    <param name='sb_attr_id' display='Specific biotope attribute ID' datatype='integer'/>
    <param name='sat_attr_id' display='SAT attribute ID' datatype='integer'/>
  </params>
  <columns>
    <column name="bb_term" sql="t_bb.term" display="Broad biotope" />
    <column name="sb_term" sql="t_sb.term" display="Specific biotope" />
    <column name="id" sql="t_sat.id" visible="false" in_count="true" />
    <column name="sample_id" sql="s.id" visible="false" />
    <column name="term_id" sql="t_sat.id" visible="false" />
    <column name="term" sql="case when p.id=t_sb.id then '' else p.term || ' &gt;&gt; ' end ||  t_sat.term" display="SAT" />
    <column name="count" sql="count(distinct o.preferred_taxa_taxon_list_id)" display="Count" aggregate="true"/>
    <column name="parent_sat_id" visible="false"
            sql="case when p.id=t_sb.id then 0 else t_sat.parent_id end" />
    <column name="rep" display="% representation" aggregate="true"
            sql="count(distinct o.preferred_taxa_taxon_list_id) * 100 / (
      select count(distinct ttlsub.preferred_taxa_taxon_list_id)
      from cache_taxa_taxon_lists ttlsub
      join taxa_taxon_list_attribute_values avsub
        on avsub.taxa_taxon_list_id=ttlsub.id
        and avsub.taxa_taxon_list_attribute_id=#sat_attr_id#
        and avsub.int_value=t_sat.id
    )" />
    <column name="cons" display="Conservation status" aggregate="true" sql="string_agg(td.code, '|' order by td.code)" />
    <column name="threshold" sql="it.threshold" visible="false" />
    <column name="code" sql="tcode.term" display="Code" />
    <column name="condition" sql="case when count(distinct o.preferred_taxa_taxon_list_id)&gt;=it.threshold then 'Favourable' else 'Unfavourable' end"
            aggregate="true" display="Reported condition" />
  </columns>
</report>