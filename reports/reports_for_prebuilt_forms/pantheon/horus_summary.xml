<report
    title="HORUS summary"
    description="Summary view of a sample for HORUS."
>
  <query website_filter_field="o.website_id">
    select 1 as sort, 'Number of species' as property, count(distinct o.preferred_taxa_taxon_list_id)::varchar as value
    from cache_occurrences o
    where o.sample_id=#sample_id#
    union
    select 2, 'Number of species with Horus coding', count(distinct preferred_taxa_taxon_list_id)::varchar
    from cache_occurrences o
    join taxa_taxon_list_attribute_values ttlav on ttlav.taxa_taxon_list_id=o.preferred_taxa_taxon_list_id and ttlav.deleted=false
    join taxa_taxon_list_attributes ttla on ttla.id=ttlav.taxa_taxon_list_attribute_id and ttlav.deleted=false
    and (ttla.caption='rarity score' or ttla.description='Pantheon quality indices')
    where o.sample_id=#sample_id#
    union
    select 3, term, array_to_string(array_agg(count::varchar || ' ' || code), '; ')
    from (
    select cat.term, td.code, count(distinct o.preferred_taxa_taxon_list_id)
    from taxon_designations td
    join taxa_taxon_designations ttd on ttd.taxon_designation_id=td.id and ttd.deleted=false
    join taxa_taxon_lists ttl on ttl.taxon_id=ttd.taxon_id and ttl.deleted=false
    join cache_taxa_taxon_lists cttl on cttl.id=ttl.id
    join cache_occurrences_functional o on o.preferred_taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id
    join cache_termlists_terms cat on cat.id=td.category_id
    where td.deleted=false
    and ttl.taxon_list_id=#taxon_list_id#
    and o.sample_id=#sample_id#
    group by cat.term, td.code
    ) as subtable
    group by term
    order by sort
  </query>
  <params>
    <param name='sample_id' display='Sample ID'  datatype='integer'/>
    <param name='taxon_list_id' display='Taxon list ID'  datatype='integer'/>
  </params>
</report>