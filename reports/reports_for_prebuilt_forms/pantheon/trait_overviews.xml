<report
    title="Trait Overviews"
    description="A report which displays all the traits of a particular trait type associated with a sample.
Optionally a second attribute can be supplied to display two levels of trait type if needed (e.g. Broad and Specific assemblage types)."
>
  <query website_filter_field="o.website_id">
    SELECT #columns#
    from terms ttraitDesc
      join termlists_terms tttraitDesc on tttraitDesc.term_id = ttraitDesc.id AND tttraitDesc.deleted=false
      join termlists_terms ttTraitCode on ttTraitCode.meaning_id = tttraitDesc.meaning_id  AND ttTraitCode.termlist_id=tttraitDesc.termlist_id AND ttTraitCode.term_id!=tttraitDesc.term_id AND ttTraitCode.deleted=false
      join terms tTraitCode on tTraitCode.id = ttTraitCode.term_id AND tTraitCode.deleted=false
      join taxa_taxon_list_attribute_values ttlav on ttlav.int_value = tttraitDesc.id AND ttlav.deleted = false
      join occurrences o on o.taxa_taxon_list_id = ttlav.taxa_taxon_list_id AND o.sample_id=#sample_id# 
      left join occurrence_attribute_values oavQuant on oavQuant.occurrence_id = o.id AND oavQuant.occurrence_attribute_id = #quantity_occ_attr_id# AND oavQuant.deleted = false
      left join taxa_taxon_list_attributes ttlaTrait on ttlaTrait.id = ttlav.taxa_taxon_list_attribute_id AND ttlaTrait.id=#trait_to_display_attr_id# AND ttlaTrait.deleted=false
      left join taxa_taxon_list_attributes ttlaTrait2 on ttlaTrait2.id = ttlav.taxa_taxon_list_attribute_id AND ttlaTrait2.id=#trait_level_2_to_display_attr_id# AND ttlaTrait2.deleted=false 
    where (ttlaTrait.id IS NOT NULL OR ttlaTrait2.id IS NOT NULL) AND ttTraitCode.parent_id IS NULL AND ('#parent_trait_desc_id#'=ttTraitDesc.parent_id OR '#parent_trait_desc_id#' = '-1')
  </query>
  <params>
    <param name='sample_id' display='Sample' description='Sample id to retrieve data for.' datatype='integer'/>
    <param name='quantity_occ_attr_id' display='Quantity Occurrence Attribute Id' description='Occurrance attribute that holds the abundance for an occurrence.' datatype='integer'/>
    <param name='trait_to_display_attr_id' display='Ecological Division/Habitat or Resource Attribute Id' description='Trait attribute id for Ecological Division, Habitat or Resource.' datatype='integer'/>
    <param name='trait_level_2_to_display_attr_id' display='Ecological Division/Habitat or Resource Attribute Id' description='Trait attribute id for Ecological Division, Habitat or Resource.' datatype='integer' default='0' emptyvalue='0'/>
    <param name='taxa_taxon_list_trait_attr_ids' display='Trait Attribute Ids' description='Comma separated list of the attribute ids that hold species traits.' datatype='text'/>
    <param name='trait_link_path' display='Trait Link Path' description='Page path that clicking on a trait links to.' datatype='text' default=' ' emptyvalue=' '/>
    <param name="clean_url" datatype="integer" default='-1' emptyvalue='-1'/>
    <param name="parent_trait_desc_id" datatype="integer" default='-1' emptyvalue='-1'/>
  </params>
  <columns>
    <column name='trait_desc' sql="
    case '#clean_url#'
      WHEN '1'
        THEN '&lt;a href=&quot;'||'#trait_link_path#'||'?dynamic-sample_id='||'#sample_id#' || '&amp;dynamic-parent_trait_desc_id='||ttTraitDesc.id||'&quot;&gt;' || ttraitDesc.term
      WHEN '0'
        THEN '&lt;a href=&quot;'||'#trait_link_path#'||'?q='||'&amp;dynamic-sample_id='||'#sample_id#'|| '&amp;dynamic-parent_trait_desc_id='||ttTraitDesc.id||'&quot;&gt;' || ttraitDesc.term
      ELSE
        ttraitDesc.term
    END" display='Trait Description' in_count='true'/>
    <column name='trait_code' sql='tTraitCode.term' display='Trait Code' />
    <column name='trait_desc_id' sql='ttTraitDesc.id' visible='false' display='Trait Description ID'/>
    <column name='trait_desc_parent_id' sql='ttTraitDesc.parent_id' visible='false' display='Parent Trait Description ID'/>
    <column name='count' sql='
    sum(case when 
    (select count(*)
    from taxa_taxon_list_attribute_values ttlAV 
    where ttlAV.taxa_taxon_list_id=o.taxa_taxon_list_id AND ttlAV.taxa_taxon_list_attribute_id in (#taxa_taxon_list_trait_attr_ids#) AND ttlAV.deleted = false)
    > 0 then oavQuant.int_value else 0 END)' display='Count' aggregate='true'/>
  </columns>
</report>