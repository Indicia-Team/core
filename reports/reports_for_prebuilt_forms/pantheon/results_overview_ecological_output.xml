<report
    title="Results overview - ecological output"
    description="A report to display the ecological guild details on the Results Overview page."
>
  <query website_filter_field="o.website_id">
    select #columns#
    from cache_occurrences o
    join taxa_taxon_list_attribute_values ttlav on ttlav.taxa_taxon_list_id=o.preferred_taxa_taxon_list_id and ttlav.deleted=false
    and ttlav.taxa_taxon_list_attribute_id in (#adult_attr_id#, #larval_attr_id#)
    join cache_termlists_terms tguild on tguild.id=ttlav.int_value
    where sample_id=#sample_id#
  </query>
  <order_bys>
    <order_by>count(distinct o.preferred_taxa_taxon_list_id) desc</order_by>
  </order_bys>
  <params>
    <param name='sample_id' display='Sample' description='Sample id to retrieve data for.' datatype='integer'/>
    <param name='adult_attr_id' display='Adult Guild Occurrence Attribute Id' description='Occurrance attribute that holds adult guild.' datatype='integer'/>
    <param name='larval_attr_id' display='Larval Guild Occurrence Attribute Id' description='Occurrance attribute that holds larval guild.' datatype='integer'/>
  </params>
  <columns>
    <column name="sample_id" sql="o.sample_id" />
    <column name="trait_term_id" sql="tguild.id" />
    <column name="stage" sql="case ttlav.taxa_taxon_list_attribute_id when #adult_attr_id# then 'adult' else 'larva' end"  in_count="true"/>
    <column name='guild' sql="tguild.term" in_count="true" />
    <column name='count' sql='count(distinct o.preferred_taxa_taxon_list_id)' aggregate='true'/>
    <column name="ret" display="% return" aggregate="true"
            sql="count(distinct o.preferred_taxa_taxon_list_id) * 100 / (
      select count(osub.id) from cache_samples_functional ssub
      join cache_occurrences_functional osub
        on osub.website_id=ssub.website_id and osub.survey_id=ssub.survey_id and osub.sample_id=ssub.id
      where ssub.id=#sample_id#
    )" />
    <column name="trait_attr_id" sql="ttlav.taxa_taxon_list_attribute_id" />
  </columns>
</report>