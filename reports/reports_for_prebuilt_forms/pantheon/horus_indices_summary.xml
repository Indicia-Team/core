<report
    title="HORUS indices summary"
    description="Summary view of a sample for HORUS indices on the 2 page report."
    >
  <query website_filter_field="o.website_id">
select 
  #columns#
from (
  select a.caption, 'Fidelity ' || coalesce(at.term, av.int_value::varchar) as score, sum(av.int_value) as int_score, sum(avr.int_value) as rarity_score, count(o.taxon_meaning_id) as count
  from taxa_taxon_list_attribute_values av
  join taxa_taxon_list_attributes a on a.id=av.taxa_taxon_list_attribute_id and a.description='Pantheon quality indices'
  join cache_occurrences o on o.preferred_taxa_taxon_list_id=av.taxa_taxon_list_id
  left join (taxa_taxon_list_attribute_values avr 
    join taxa_taxon_list_attributes ar on ar.id=avr.taxa_taxon_list_attribute_id and avr.deleted=false and ar.caption='rarity score'
  ) on avr.taxa_taxon_list_id=av.taxa_taxon_list_id and avr.deleted=false
  left join cache_termlists_terms at on at.id=av.int_value and a.data_type='L'
  where o.sample_id=#sample_id#
  group by a.caption, at.term, av.int_value
  order by a.caption, coalesce(at.term, av.int_value::varchar), coalesce(at.term, av.int_value::varchar)
) sub
  </query>
  <order_bys>
    <order_by>sub.caption</order_by>
  </order_bys>
  <params>
    <param name='sample_id' display='Sample ID'  datatype='integer'/>
  </params>
  <columns>
    <column name="indices" sql="sub.caption" />
    <column name="score" sql="case 
    when sub.caption like 'IEC%' or caption='grazing marsh - salinity' then sum(sub.int_score)::varchar
    when sub.caption='peat bog spiders' then round((sub.rarity_score/sub.count::float)::numeric, 2)::varchar
    when sub.caption='grazing marsh - species' then round(sum(sub.int_score)/sub.count, 2)::varchar
    else string_agg(sub.count::varchar || ' ' || sub.score, ', ') 
  end || case 
    when sub.caption like 'ERS%' then ', ERSQI ' || (round(sum(sub.int_score)/sum(sub.count)*100))::varchar
    else ''
  end" aggregate="true" />
    <column name="number_of_species" sql="sub.count" />
    <column name="rarity_score" sql="sub.rarity_score" visible="false" />
  </columns>
</report>