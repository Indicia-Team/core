<report
    title="Trait Overviews"
    description="A report which displays all the traits of a particular trait type or list of types associated with a sample."
>
  <query website_filter_field="o.website_id">
    select #columns#
    from taxa_taxon_list_attribute_values ttlav
    join cache_termlists_terms t on t.id=ttlav.int_value
    join cache_occurrences o on o.preferred_taxa_taxon_list_id=ttlav.taxa_taxon_list_id
    where ttlav.deleted=false
    and o.sample_id=#sample_id#
    #filters#
  </query>
  <order_bys>
    <order_by>t.term</order_by>
  </order_bys>
  <params>
    <param name='sample_id' display='Sample' description='Sample id to retrieve data for.' datatype='integer'/>
    <param name='trait_attr_ids' display='Trait IDs' description='Comma separated list of traits to return' datatype='integer[]' default="">
      <where>ttlav.taxa_taxon_list_attribute_id in (#trait_attr_ids#)</where>
    </param>
    <param name="parent_id" display="Parent trait term ID" datatype="integer" default="">
      <where>t.parent_id=#parent_id#</where>
    </param>
  </params>
  <columns>
    <column name="sample_id" sql="o.sample_id" />
    <column name="trait_term_id" sql="t.id" />
    <column name="parent_term_id" sql="t.parent_id" />
    <column name="trait" sql="t.term" />
    <column name="count" sql="count(distinct o.preferred_taxa_taxon_list_id)" aggregate="true" />
    <column name="trait_attr_id" sql="ttlav.taxa_taxon_list_attribute_id" />
    <column name="rep" display="% representation" aggregate="true"
            sql="count(distinct o.preferred_taxa_taxon_list_id) * 100 / (
      select count(distinct ttlsub.preferred_taxa_taxon_list_id)
      from cache_taxa_taxon_lists ttlsub
      join taxa_taxon_list_attribute_values avsub
        on avsub.taxa_taxon_list_id=ttlsub.id
        and avsub.taxa_taxon_list_attribute_id in (#trait_attr_ids#)
        and avsub.int_value=t.id
    )" />
  </columns>
</report>