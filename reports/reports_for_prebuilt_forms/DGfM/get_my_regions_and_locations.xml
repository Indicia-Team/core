<report
    title="Get my regions and locations"
    description="Get a list of Core Regions and Additional Regions that have been assigned to the user and list them with their associated locations. Only locations without samples are editable.
Include only_return_private_locations to only return private locations associated with the user (no parent regions or public locations).
Include only_show_my_useable_locations_regions to only return locations and regions the user is allowed save data against, the current rule is:
any regions they are assigned to, any location the user created, 
or any location they are assigned to which they didn't create (as long as they are the only person assigned to the location's region)."
>
  <query website_filter_field="lw.website_id">
    SELECT #columns#
    FROM locations l
      LEFT JOIN locations_websites lw on lw.location_id=l.id AND lw.deleted=false
      LEFT JOIN samples locationSamples on locationSamples.location_id = l.id
      LEFT JOIN termlists_terms ttLocationType on ttLocationType.id = l.location_type_id
      LEFT JOIN terms termLocationType on termLocationType.id = ttLocationType.term_id
      JOIN locations region on (region.id=l.id OR region.id=l.parent_id) AND region.location_type_id=#core_region_location_type_id#
    #joins#
    WHERE (l.id = region.id OR l.parent_id = region.id)
    AND #website_filter# AND l.deleted=false
    GROUP BY region.id,l.parent_id,l.id,lavlocationname.text_value,termlocationtype.term,pav.updated_by_id,u.id,lavPriv.int_value,ttlocationtype.id
  </query>
  <order_bys>
    <order_by>region.id,l.parent_id desc</order_by>
  </order_bys>
  <params>
    <param name="region_location_type_id" display="Core Region location type id" datatype="integer"/>
    <param name="current_user_id" display="Id of the currently logged in user" datatype="integer" default="0" emptyvalue="0"/>
  </params>
  <columns>
    <column name='id' display='Location ID' sql="l.id" datatype='integer' visible="false" in_count="true"/>
    <column name='region_id' display='Region ID' sql="region.id" datatype='integer' visible="false"/>
    <column name='parent_id' display='Parent ID' sql="l.parent_id" datatype='integer' visible="false"/>
    <column name='region_entered_sref' display='Region spatial reference' sql="region.centroid_sref" visible="false"/>
    <column name='location_entered_sref' display='Location spatial reference (location or region)' sql="l.centroid_sref" visible="false"/>
    <column name='name' display='Location Name' sql="l.name" datatype='text' />
    <column name='location_type' display='Region or location type' sql="
      case 
        when l.parent_id is null then 'region' 
        else 'location'
    end" visible="false"/>  
  </columns> 
</report>