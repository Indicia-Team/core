<report
    title="Language Indenpendent Taxa_Taxon_List_Attribute_Values"
    description="List of taxa_taxon_list_attribute_values that returns the raw_value using the termlists_term ID for different languages."
>
  <query website_filter_field="tlttla.website_id">
    SELECT #columns#
    FROM taxa_taxon_lists ttl
      JOIN taxon_lists_taxa_taxon_list_attributes tlttla ON tlttla.taxon_list_id = ttl.taxon_list_id AND tlttla.deleted = false
      JOIN taxa_taxon_list_attributes a ON a.id = tlttla.taxa_taxon_list_attribute_id AND a.deleted = false
      JOIN taxa_taxon_list_attribute_values av ON av.taxa_taxon_list_attribute_id = a.id AND av.taxa_taxon_list_id = ttl.id AND av.deleted = false
      LEFT JOIN cache_termlists_terms ctt ON ctt.id = av.int_value
      LEFT JOIN cache_termlists_terms ctt_deu on ctt_deu.meaning_id = ctt.meaning_id AND ctt_deu.language_iso = 'deu'
      LEFT JOIN cache_termlists_terms ctt_eng on ctt_eng.meaning_id = ctt.meaning_id AND ctt_eng.language_iso = 'eng'
      LEFT JOIN cache_termlists_terms ctt_cze on ctt_cze.meaning_id = ctt.meaning_id AND ctt_cze.language_iso = 'cze'
    WHERE ttl.id=#taxa_taxon_list_id# AND ttl.deleted = false
  </query>
  <order_bys>
    <order_by>av.id desc</order_by>
  </order_bys>
  <params>
    <param name='taxa_taxon_list_id' display='Taxa taxon list Id' description='Id of species list item to restrict report to' datatype='integer'/> 
  </params>
  <columns>
    <column name="taxa_taxon_list_attribute_id" display="ID" sql="a.id" datatype="integer" />
    <column name="raw_value" display="Raw value" sql="
      CASE a.data_type
        WHEN 'T'::bpchar THEN av.text_value
        WHEN 'L'::bpchar THEN av.int_value::text
        WHEN 'I'::bpchar THEN av.int_value::text
        WHEN 'B'::bpchar THEN av.int_value::text
        WHEN 'F'::bpchar THEN av.float_value::text
        WHEN 'D'::bpchar THEN av.date_start_value::text
        WHEN 'V'::bpchar THEN (av.date_start_value::text || ' - '::text) || av.date_end_value::text
        WHEN 'G'::bpchar THEN st_astext(av.geom_value)
        ELSE NULL::text
      END
    " datatype="text" />
    <column name="upper_value" display="Upper value" sql="av.upper_value::text" datatype="text" />
    <column name="deu_value" display="German value" sql="ctt_deu.id" datatype="integer" />
    <column name="eng_value" display="English value" sql="ctt_eng.id" datatype="integer" />
    <column name="cze_value" display="Czech value" sql="ctt_cze.id" datatype="integer" />
  </columns>
</report>
