<?xml version="1.0" encoding="UTF-8"?>

<report title="UKBMS Year Index Plot report" description="UKBMS specific: Lists occurrences at a section level.">
      <query website_filter_field='o.website_id'>
      SELECT #columns#
      FROM samples s
      JOIN occurrences o ON o.sample_id=s.id AND o.zero_abundance='f' AND o.deleted = 'f'
      JOIN cache_taxa_taxon_lists cttl ON o.taxa_taxon_list_id = cttl.id
      #joins#
      WHERE s.location_id = #location_id#
      AND s.parent_id IS NULL
      AND s.sample_method_id = #sample_method_id# AND s.deleted = 'f'
      AND #website_filter#
      </query>
      <params>
    	<param name='location_id' display='Location ID' description='Enter the ID of the location' datatype='int' />
        <param name='occattrs' display='Occurrence attribute list' description='Comma separated list of occurrence attribute IDs to include' datatype='occattrs' />
    	<param name='taxon_list_id' display='Taxon List ID' datatype='int' >
	      <where>cttl.taxon_list_id = #taxon_list_id#</where>
		</param>
		<param name='sample_method_id' display='Sample Method' description='Select the sample method, or leave blank to not filter by sample method.' datatype='lookup'
            population_call='report:library/terms/terms_list:termlists_term_id:term:termlist_external_key=indicia:sample_methods,termlist_id=' />
      </params>
      <columns>
            <column name="location_id" display="ID" sql="s.location_id" in_count="true" datatype="integer" />
            <column name="taxon" display="Taxon" sql="coalesce(cttl.default_common_name, cttl.preferred_taxon, cttl.taxon)" datatype="text" />
            <column name="preferred_taxon" display="Preferred Taxon" sql="cttl.taxon" datatype="text" />
            <column name="taxon_meaning_id" display="Taxon Meaning ID" sql="cttl.taxon_meaning_id" datatype="text" />
            <column name="year" display="Year" sql="s.date_start" datatype="text" />
      </columns>
      
</report>