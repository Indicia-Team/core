<report
    title="View Data"
    description="Report to display the View Data page on Earthworm Watch for admin users. Includes location information."
>
  <query website_filter_field="su.website_id">
  SELECT #columns#
  FROM samples s
  LEFT JOIN sample_attribute_values pitNumAttr ON pitNumAttr.sample_id=s.id AND pitNumAttr.sample_attribute_id=#s1AttrID# AND pitNumAttr.deleted=false
  JOIN cache_occurrences co on co.sample_id=s.id
  JOIN occurrence_attribute_values countAttr ON countAttr.occurrence_id=co.id AND countAttr.occurrence_attribute_id=#occ_count_attr_id# AND countAttr.deleted=false
  JOIN sample_attribute_values livePlantAttr ON livePlantAttr.sample_id=s.id AND livePlantAttr.sample_attribute_id=#live_plant_cover_attr_id# AND livePlantAttr.deleted=false
  JOIN termlists_terms ttLivePlant on ttLivePlant.id = livePlantAttr.int_value AND ttLivePlant.deleted=false
  JOIN terms tlivePlant on tLivePlant.id = ttLivePlant.term_id AND tLivePlant.deleted=false
  JOIN sample_attribute_values coverTypeAttr ON coverTypeAttr.sample_id=s.id AND coverTypeAttr.sample_attribute_id=#coverage_type_attr_id# AND coverTypeAttr.deleted=false
  JOIN termlists_terms ttCoverType on ttCoverType.id = coverTypeAttr.int_value AND ttCoverType.deleted=false
  JOIN terms tCoverType on tCoverType.id = ttCoverType.term_id AND tCoverType.deleted=false
  JOIN sample_attribute_values moistAttr ON moistAttr.sample_id=s.id AND moistAttr.sample_attribute_id=#moisture_attr_id# AND moistAttr.deleted=false
  JOIN termlists_terms ttMoist on ttMoist.id = moistAttr.int_value AND ttMoist.deleted=false
  JOIN terms tMoist on tMoist.id = ttMoist.term_id AND tMoist.deleted=false  
  JOIN sample_attribute_values fizzAttr ON fizzAttr.sample_id=s.id AND fizzAttr.sample_attribute_id=#fizz_attr_id# AND fizzAttr.deleted=false
  JOIN termlists_terms ttFizz on ttFizz.id = fizzAttr.int_value AND ttFizz.deleted=false
  JOIN terms tFizz on tFizz.id = ttFizz.term_id AND tFizz.deleted=false  
  JOIN sample_attribute_values textureAttr ON textureAttr.sample_id=s.id AND textureAttr.sample_attribute_id=#texture_attr_id# AND textureAttr.deleted=false
  JOIN termlists_terms ttTexture on ttTexture.id = textureAttr.int_value AND ttTexture.deleted=false
  JOIN terms tTexture on tTexture.id = ttTexture.term_id AND tTexture.deleted=false  
  JOIN sample_attribute_values colourAttr ON colourAttr.sample_id=s.id AND colourAttr.sample_attribute_id=#colour_attr_id# AND colourAttr.deleted=false
  JOIN termlists_terms ttColour on ttColour.id = colourAttr.int_value AND ttColour.deleted=false
  JOIN terms tColour on tColour.id = ttColour.term_id AND tColour.deleted=false 
  JOIN surveys su on su.id=s.survey_id and su.id = #survey_id# and su.deleted=false
  JOIN websites w on w.id=su.website_id and w.deleted=false
  WHERE
  #website_filter#
  AND s.deleted=false
  AND ((co.training=false AND #training_records#!=1) or (co.training=true AND #training_records#=1))
  </query>
  <order_bys>
    <order_by>s.id DESC</order_by>
  </order_bys>
  <params>
    <param name='s1AttrID' display='Sample 1 Attribute ID' description='The ID of the sample attribute that links pit 2 to the first' datatype='int' />
    <param name='live_plant_cover_attr_id' display='Live Plant Coverage Attribute ID' description='The ID of the attribute that holds the recorded live plan coverage.' datatype='int' />
    <param name='coverage_type_attr_id' display='Square Coverage Attribute ID' description='The ID of the attribute that holds the recorded square coverage.' datatype='int' />
    <param name='moisture_attr_id' display='Soil Moisture Attribute ID' description='The ID of the attribute that holds the recorded soil moisture.' datatype='int' />
    <param name='fizz_attr_id' display='Soil Fizz Attribute ID' description='The ID of the attribute that holds the recorded soil fizz.' datatype='int' />
    <param name='texture_attr_id' display='Soil Texture Attribute ID' description='The ID of the attribute that holds the recorded soil texture.' datatype='int' />
    <param name='colour_attr_id' display='Soil Colour Attribute ID' description='The ID of the attribute that holds the recorded soil colour.' datatype='int' />
    <param name='occ_count_attr_id' display='Eathworm Count Attribute ID' description='The ID of the attribute that holds the Earthworm count.' datatype='int' />
    <param name='survey_id' display='Survey ID' description='ID of the survey to show data for.' datatype='int'/>
    <param name='training_records' display='Training records?' description='Show training records instead?.' datatype='int' emptyvalue='0' default='0'/>
  </params>
  <columns>
    <column name='sample_id' display='ID' sql='s.id' datatype="integer" visible='false' in_count="true"/>
    <column name='person_visible_name' display='Name' sql='s.recorder_names' datatype="text"/>
    <column name='pit_num' display='Pit Number' sql="case when pitNumAttr.int_value is null OR pitNumAttr.int_value = 0 then 'Pit 1' else 'Pit 2' End" datatype="text"/>
    <column name='location_name' display='Location Name' sql='s.location_name' datatype="text"/>
    <column name='entered_sref' display='Spatial Reference' sql='s.entered_sref' datatype="text"/>
    <column name='date_start' sql='s.date_start' visible='false' />
    <column name='date_end' sql='s.date_end' visible='false' />
    <column name='date_type' sql='s.date_type' visible='false' />
    <column name='date' display='Date' datatype="date" />
    <column name='square_coverage' display='Live Plant Coverage' sql='tlivePlant.term' datatype="text"/>
    <column name='plant_coverage' display='What Covers Most Of Square?' sql='tCoverType.term' datatype="text"/>
    <column name='moisture' display='Soil Moisture' sql='tMoist.term' datatype="text"/>
    <column name='fizz' display='Did Soil Fizz With Vinegar?' sql='tFizz.term' datatype="text"/>
    <column name='texture' display='Soil Texture' sql='tTexture.term' datatype="text"/>
    <column name='colour' display='Soil Colour' sql='tColour.term' datatype="text"/>
    <column name='count' display='Earthworm Count' sql='sum(countAttr.int_value)' datatype="integer" aggregate="true"/>
  </columns>
</report>