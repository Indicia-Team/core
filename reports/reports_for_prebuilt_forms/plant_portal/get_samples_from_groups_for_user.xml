<report
    title="Get samples in groups for user."
    description="Get the samples in the groups the user has permission to use."
    >
  <query website_filter_field="csf.website_id">
    select #columns#
    from person_attribute_values pavPerm
    join people p on p.id=pavPerm.person_id AND p.deleted=false
    join users u on u.person_id=p.id AND u.id=#user_id# AND u.deleted=false
    join termlists_terms sampGroupTT on sampGroupTT.id = pavPerm.int_value AND sampGroupTT.deleted=false
    join terms sampGroupT on sampGroupT.id = sampGroupTT.term_id AND sampGroupT.deleted=false
    join sample_attribute_values savPerm on savPerm.int_value = sampGroupTT.id AND savPerm.sample_attribute_id='#sample_group_permission_person_attr_id#' AND savPerm.deleted=false
    join cache_samples_functional csf on csf.id = savPerm.sample_id
    join cache_samples_nonfunctional csnf on csnf.id = csf.id
    left join locations plot on plot.id = csf.location_id AND plot.deleted=false
    left join location_attribute_values lavPerm on lavPerm.location_id = plot.id AND lavPerm.deleted=false
    join termlists_terms plotGroupTT on plotGroupTT.id = lavPerm.int_value AND plotGroupTT.deleted=false
    join terms plotGroupT on plotGroupT.id = plotGroupTT.term_id AND plotGroupT.deleted=false
    WHERE pavPerm.deleted=false AND pavPerm.person_attribute_id = #sample_group_permission_person_attr_id#
    AND #website_filter#
  </query>
  <params>
    <param name="sample_group_permission_person_attr_id" display="Sample group permission persons attr id" description="The id of the attribute that hold sample group permissions." datatype="integer"/>
    <param name="plot_group_permission_person_attr_id" display="Plot group permissions person attr id" description="The id of the attribute that hold plot group permissions." datatype="integer"/>
    <param name="plot_group_attr_id" display="Plot group attribute id" description="The id of the plot group attribute." datatype="integer"/>
    <param name="user_id" display="Indicia user id" description="Indicia user id for find sample group permissions for." datatype="integer"/>
  </params>
  <columns>
    <column name="sample_id" sql="csf.id" display="Sample ID" visible="false" in_count="true"/>
    <column name="entered_sref" sql="csnf.public_entered_sref" display="Sample spatial reference"/>
    <column name="sample_group_identifier_name" sql="sampGroupT.term" display="Sample group identifier name"/>
    <column name="plot_id" sql="plot.id" display="Plot ID"/>
    <column name="plot_name" sql="plot.name" display="Name"/>
    <column name="plot_group_identifier_name" sql="plotGroupT.term" display="Plot group identifier name"/>
  </columns>
</report>