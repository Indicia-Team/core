<report
    title="Species Data"
    description="Report used to retrieve description of a species and images associated with its taxon_meaning_id."
>
  <query website_filter_field="o.website_id">
    SELECT 'image', path as the_text, 
	CASE WHEN exif::json->>'bildnummer' IS NOT NULL THEN 'Bildnummer: ' || coalesce((exif::json->>'bildnummer'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'taxRef_gattung' IS NOT NULL THEN 'TaxRef_gattung: ' || coalesce((exif::json->>'taxRef_gattung'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'art' IS NOT NULL THEN 'Art: ' || coalesce((exif::json->>'art'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'taxref_ID' IS NOT NULL THEN 'Taxref_ID: ' || coalesce((exif::json->>'taxref_ID'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'bildkategorie' IS NOT NULL THEN 'Bildkategorie: ' || coalesce((exif::json->>'bildkategorie'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'TKnr' IS NOT NULL THEN 'TKnr: ' || coalesce((exif::json->>'TKnr'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'TKname' IS NOT NULL THEN 'TKname: ' || coalesce((exif::json->>'TKname'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'land' IS NOT NULL THEN 'Land: ' || coalesce((exif::json->>'land'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'bundesland' IS NOT NULL THEN 'Bundesland: ' || coalesce((exif::json->>'bundesland'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'regierungsbezirk' IS NOT NULL THEN 'Regierungsbezirk: ' || coalesce((exif::json->>'regierungsbezirk'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'landkreis' IS NOT NULL THEN 'Landkreis: ' || coalesce((exif::json->>'landkreis'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'fundort_1' IS NOT NULL THEN 'Fundort_1: ' || coalesce((exif::json->>'fundort_1'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'NN_hohe' IS NOT NULL THEN 'NN_hohe: ' || coalesce((exif::json->>'NN_hohe'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'begleitpflanzen' IS NOT NULL THEN 'Begleitpflanzen: ' || coalesce((exif::json->>'begleitpflanzen'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'datum_gesammelt' IS NOT NULL THEN 'Datum_gesammelt: ' || coalesce((exif::json->>'datum_gesammelt'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'leg' IS NOT NULL THEN 'Leg: ' || coalesce((exif::json->>'leg'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'det' IS NOT NULL THEN 'Det: ' || coalesce((exif::json->>'det'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'conf' IS NOT NULL THEN 'Conf: ' || coalesce((exif::json->>'conf'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'fot' IS NOT NULL THEN 'Fot: ' || coalesce((exif::json->>'fot'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'herbar' IS NOT NULL THEN 'Herbar: ' || coalesce((exif::json->>'herbar'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'herbarbelegnr' IS NOT NULL THEN 'Herbarbelegnr: ' || coalesce((exif::json->>'herbarbelegnr'), '') || chr(10) ELSE '' END ||
	CASE WHEN exif::json->>'anmerkung' IS NOT NULL THEN 'Anmerkung: ' || coalesce((exif::json->>'anmerkung'), '') ELSE '' END as caption,
	
	CASE WHEN exif::json->>'bildnummer' IS NOT NULL THEN 'Bildnummer: ' || coalesce((exif::json->>'bildnummer'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'taxRef_gattung' IS NOT NULL THEN 'TaxRef_gattung: ' || coalesce((exif::json->>'taxRef_gattung'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'art' IS NOT NULL THEN 'Art: ' || coalesce((exif::json->>'art'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'taxref_ID' IS NOT NULL THEN 'Taxref_ID: ' || coalesce((exif::json->>'taxref_ID'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'bildkategorie' IS NOT NULL THEN 'Bildkategorie: ' || coalesce((exif::json->>'bildkategorie'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'TKnr' IS NOT NULL THEN 'TKnr: ' || coalesce((exif::json->>'TKnr'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'TKname' IS NOT NULL THEN 'TKname: ' || coalesce((exif::json->>'TKname'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'land' IS NOT NULL THEN 'Land: ' || coalesce((exif::json->>'land'), '') || '&lt;br&gt;' ELSE '' END ||
	CASE WHEN exif::json->>'bundesland' IS NOT NULL THEN 'Bundesland: ' || coalesce((exif::json->>'bundesland'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'regierungsbezirk' IS NOT NULL THEN 'Regierungsbezirk: ' || coalesce((exif::json->>'regierungsbezirk'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'landkreis' IS NOT NULL THEN 'Landkreis: ' || coalesce((exif::json->>'landkreis'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'fundort_1' IS NOT NULL THEN 'Fundort_1: ' || coalesce((exif::json->>'fundort_1'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'NN_hohe' IS NOT NULL THEN 'NN_hohe: ' || coalesce((exif::json->>'NN_hohe'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'begleitpflanzen' IS NOT NULL THEN 'Begleitpflanzen: ' || coalesce((exif::json->>'begleitpflanzen'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'datum_gesammelt' IS NOT NULL THEN 'Datum_gesammelt: ' || coalesce((exif::json->>'datum_gesammelt'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'leg' IS NOT NULL THEN 'Leg: ' || coalesce((exif::json->>'leg'), '') || '&lt;br&gt;' ELSE '' END ||
	CASE WHEN exif::json->>'det' IS NOT NULL THEN 'Det: ' || coalesce((exif::json->>'det'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'conf' IS NOT NULL THEN 'Conf: ' || coalesce((exif::json->>'conf'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'fot' IS NOT NULL THEN 'Fot: ' || coalesce((exif::json->>'fot'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'herbar' IS NOT NULL THEN 'Herbar: ' || coalesce((exif::json->>'herbar'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'herbarbelegnr' IS NOT NULL THEN 'Herbarbelegnr: ' || coalesce((exif::json->>'herbarbelegnr'), '') || ', ' ELSE '' END ||
	CASE WHEN exif::json->>'anmerkung' IS NOT NULL THEN 'Anmerkung: ' || coalesce((exif::json->>'anmerkung'), '') ELSE '' END as caption_html,
	
    case

    when external_details = 'Micro detail' AND '#language#'='en' then
      'Micro detail'
    when external_details = 'Micro detail' AND '#language#'='de' then
      'Mikrobild'
    when external_details = 'Micro detail' AND '#language#'='cs' then
      'Mikrofoto'

    when external_details = 'Mikrobild' AND '#language#'='en' then
      'Micro detail'
    when external_details = 'Mikrobild' AND '#language#'='de' then
      'Mikrobild'
    when external_details = 'Mikrobild' AND '#language#'='cs' then
      'Mikrofoto' 

    when external_details = 'Mikrofoto' AND '#language#'='en' then
      'Micro detail'
    when external_details = 'Mikrofoto' AND '#language#'='de' then
      'Mikrobild'
    when external_details = 'Mikrofoto' AND '#language#'='cs' then
      'Mikrofoto' 

    when external_details = 'Appearance' AND '#language#'='en' then
      'Appearance'
    when external_details = 'Appearance' AND '#language#'='de' then
      'Habitus'
    when external_details = 'Appearance' AND '#language#'='cs' then
      'Celkový vzhled'

    when external_details = 'Habitus' AND '#language#'='en' then
      'Appearance'
    when external_details = 'Habitus' AND '#language#'='de' then
      'Habitus'
    when external_details = 'Habitus' AND '#language#'='cs' then
      'Celkový vzhled'

    when external_details = 'Celkový vzhled' AND '#language#'='en' then
      'Appearance'
    when external_details = 'Celkový vzhled' AND '#language#'='de' then
      'Habitus'
    when external_details = 'Celkový vzhled' AND '#language#'='cs' then
      'Celkový vzhled'

    when external_details = 'Habitat' AND '#language#'='en' then
      'Habitat'
    when external_details = 'Habitat' AND '#language#'='de' then
      'Standort'
    when external_details = 'Habitat' AND '#language#'='cs' then
    'Stanoviště'

    when external_details = 'Standort' AND '#language#'='en' then
      'Habitat'
    when external_details = 'Standort' AND '#language#'='de' then
      'Standort'
    when external_details = 'Standort' AND '#language#'='cs' then
      'Stanoviště'

    when external_details = 'Stanoviště' AND '#language#'='en' then
      'Habitat'
    when external_details = 'Stanoviště' AND '#language#'='de' then
      'Standort'
    when external_details = 'Stanoviště' AND '#language#'='cs' then
      'Stanoviště'  
    ELSE
      external_details
    END as external_details,
        coalesce((exif::json->>'fot')::text, 
    case when caption like '%Foto: %' then replace(split_part(caption, ',', 1), 'Foto: ', '') else null END,
    caption,
    ''
    ) 
    as author
    FROM taxon_media
    WHERE taxon_meaning_id=#taxon_meaning_id# and deleted=false
	order by (
	  case external_details 
        when 'Detail' then 1
        when 'Micro detail' then 2
        when 'Mikrobild' then 2
        when 'Mikrofoto' then 2
        when 'Appearance' then 3
        when 'Habitus' then 3
        when 'Celkový vzhled' then 3
        when 'Habitat' then 4
        when 'Standort' then 4
        when 'Stanoviště' then 4
    end)
  </query>
  <params>
    <param name='taxa_taxon_list_id' display='Taxon ID' description='ID of the taxon to loads notes for' datatype='text' emptyvalue='-1'/>
    <param name='taxon_meaning_id' display='Taxon meaning ID' description='The meaning ID of the taxon' datatype='text' emptyvalue='-1' />
    <param name='language' display='Language code' description='Drupal language code user is using' datatype='text' />
  </params>
</report>
